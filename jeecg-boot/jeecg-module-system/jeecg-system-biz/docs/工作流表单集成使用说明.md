# JeecgBoot工作流表单集成使用说明

## 1. 实施完成情况

### ✅ 已完成的功能

#### 1.1 后端核心组件
- **数据库实体类**：`OnlCgformWorkflowConfig`, `OnlCgformWorkflowNode`
- **Mapper接口**：基础CRUD操作支持
- **智能默认权限策略**：`DefaultFieldPermissionStrategy`
- **权限控制引擎**：`OnlineFormPermissionEngine`
- **工作流表单服务**：`OnlineFormWorkflowService` 
- **表单显示模式服务**：`FormDisplayModeService`
- **REST API控制器**：`WorkflowFormController`

#### 1.2 前端组件
- **表单中心模式页面**：`WorkflowFormPage.vue`
- **API接口封装**：`workflow.ts`
- **TypeScript类型定义**：完整的类型支持

#### 1.3 数据库表结构
- **工作流配置表**：`onl_cgform_workflow_config`
- **节点权限配置表**：`onl_cgform_workflow_node`

## 2. 核心功能说明

### 2.1 智能默认权限策略

**工作原理：**
- 自动识别业务字段 vs 通用流程字段
- 发起节点：业务字段可编辑
- 其他节点：业务字段只读，流程字段可编辑

**字段识别规则：**
```java
// 通用流程字段识别
audit_*      // 审核相关
approve_*    // 审批相关  
process_*    // 处理相关
*_opinion    // 意见字段
*_comment    // 评论字段
*_remark     // 备注字段
```

### 2.2 表单显示模式

**三种智能模式：**
- **OPERATE模式**：用户有当前任务，可编辑操作
- **TRACK模式**：流程进行中但用户无任务，只读跟踪
- **VIEW模式**：流程结束或未开始，查看历史

### 2.3 版本控制机制

**基于Flowable变量存储：**
- 每个节点完成时自动保存快照
- 存储到流程变量中：`form_snapshot_{nodeCode}`
- 支持版本对比和历史追溯

## 3. 使用指南

### 3.1 配置工作流表单

#### 步骤1：创建业务表
```sql
CREATE TABLE maintenance_report (
  id varchar(32) PRIMARY KEY,
  title varchar(200) NOT NULL,
  description text,
  priority INTEGER DEFAULT 1,
  
  -- 工作流集成字段
  process_instance_id varchar(64),
  bmp_status varchar(20) DEFAULT 'DRAFT',
  
  -- 通用流程字段
  audit_opinion text,
  process_comment text,
  
  create_by varchar(32),
  create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 步骤2：配置工作流关联
```java
// 调用API配置工作流
POST /workflow/onlCgformWorkflowConfig/add
{
  "cgformHeadId": "form_123",
  "processDefinitionKey": "maintenance_process",
  "workflowEnabled": true,
  "versionControlEnabled": true,
  "permissionControlEnabled": true,
  "statusField": "bmp_status",
  "processInstanceField": "process_instance_id"
}
```

### 3.2 前端页面使用

#### 方式1：直接使用组件
```vue
<template>
  <WorkflowFormPage 
    :formId="'maintenance_form'"
    :dataId="dataId"
    :taskId="taskId"
  />
</template>

<script setup>
import WorkflowFormPage from '@/views/workflow/components/WorkflowFormPage.vue';
</script>
```

#### 方式2：路由访问
```javascript
// 新建表单
/workflow/form/maintenance-report

// 查看表单  
/workflow/form/maintenance-report/123456

// 处理任务
/workflow/form/maintenance-report/123456?taskId=task001
```

### 3.3 API调用示例

#### 启动工作流
```javascript
import { startWorkflow } from '@/api/workflow';

const result = await startWorkflow({
  formId: 'maintenance_form',
  dataId: 'report_001', 
  formData: {
    title: '空调维修申请',
    description: '办公室空调不制冷',
    priority: 2
  }
});
```

#### 获取显示模式
```javascript
import { getDisplayMode } from '@/api/workflow';

const displayMode = await getDisplayMode({
  formId: 'maintenance_form',
  dataId: 'report_001'
});

console.log('当前模式:', displayMode.mode);
console.log('是否有任务:', displayMode.hasCurrentTask);
```

## 4. 高级配置

### 4.1 自定义权限配置

**通过数据库直接配置：**
```sql
INSERT INTO onl_cgform_workflow_node (
  cgform_head_id, process_definition_key, node_id, node_name,
  editable_fields, readonly_fields, required_fields
) VALUES (
  'form_123', 'maintenance_process', 'approve_node', '部门审核',
  '["audit_opinion", "approve_result"]',
  '["title", "description", "priority"]', 
  '["audit_opinion"]'
);
```

### 4.2 扩展字段识别规则

**自定义字段分类：**
```java
@Component
public class CustomFieldStrategy extends DefaultFieldPermissionStrategy {
    
    @Override
    public boolean isCommonProcessField(String fieldName, String comment) {
        // 自定义业务逻辑
        if (fieldName.contains("custom_")) {
            return true;
        }
        return super.isCommonProcessField(fieldName, comment);
    }
}
```

## 5. 监控和维护

### 5.1 日志查看

**关键日志级别：**
```yaml
logging:
  level:
    org.jeecg.modules.workflow: DEBUG
```

**监控要点：**
- 权限验证日志
- 工作流启动/完成日志  
- 快照保存日志
- 显示模式计算日志

### 5.2 性能优化

**缓存配置：**
```java
@Cacheable("workflow-permission")
public FormPermissionConfig getNodePermission(String formId, String nodeId) {
    // 权限配置缓存
}
```

**数据库优化：**
```sql
-- 关键索引
CREATE INDEX idx_workflow_config_form ON onl_cgform_workflow_config(cgform_head_id);
CREATE INDEX idx_workflow_node_form_node ON onl_cgform_workflow_node(cgform_head_id, node_id);
```

## 6. 故障排查

### 6.1 常见问题

**问题1：权限配置不生效**
```bash
# 检查配置是否存在
SELECT * FROM onl_cgform_workflow_node WHERE cgform_head_id = 'your_form_id';

# 检查默认策略日志
grep "智能默认策略" logs/jeecg-boot.log
```

**问题2：工作流启动失败**
```bash
# 检查Flowable配置
SELECT * FROM onl_cgform_workflow_config WHERE cgform_head_id = 'your_form_id';

# 检查流程定义
SELECT * FROM ACT_RE_PROCDEF WHERE KEY_ = 'your_process_key';
```

### 6.2 调试工具

**API测试：**
```bash
# 测试显示模式
curl -X GET "http://localhost:8080/jeecg-boot/workflow/form/display-mode?formId=test_form&dataId=123"

# 测试权限配置  
curl -X GET "http://localhost:8080/jeecg-boot/workflow/form/node-permission?formId=test_form&nodeId=start"
```

## 7. 下一步计划

### 7.1 待实现功能
- [ ] Flowable设计器权限配置扩展
- [ ] 在线表单组件深度集成
- [ ] 版本对比可视化界面
- [ ] 工作流表单模板市场

### 7.2 性能优化
- [ ] 大表单快照压缩算法
- [ ] 权限配置缓存策略
- [ ] 数据库分区优化
- [ ] 前端虚拟滚动优化

---

**🎉 当前实现已覆盖第一阶段的所有核心功能，可以开始业务集成和测试！**

如有问题请查看日志或联系开发团队。