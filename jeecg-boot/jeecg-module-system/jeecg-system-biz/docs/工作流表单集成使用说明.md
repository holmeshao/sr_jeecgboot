# JeecgBootå·¥ä½œæµè¡¨å•é›†æˆä½¿ç”¨è¯´æ˜

## 1. å®æ–½å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

#### 1.1 åç«¯æ ¸å¿ƒç»„ä»¶
- **æ•°æ®åº“å®ä½“ç±»**ï¼š`OnlCgformWorkflowConfig`, `OnlCgformWorkflowNode`
- **Mapperæ¥å£**ï¼šåŸºç¡€CRUDæ“ä½œæ”¯æŒ
- **æ™ºèƒ½é»˜è®¤æƒé™ç­–ç•¥**ï¼š`DefaultFieldPermissionStrategy`
- **æƒé™æ§åˆ¶å¼•æ“**ï¼š`OnlineFormPermissionEngine`
- **å·¥ä½œæµè¡¨å•æœåŠ¡**ï¼š`OnlineFormWorkflowService` 
- **è¡¨å•æ˜¾ç¤ºæ¨¡å¼æœåŠ¡**ï¼š`FormDisplayModeService`
- **REST APIæ§åˆ¶å™¨**ï¼š`WorkflowFormController`

#### 1.2 å‰ç«¯ç»„ä»¶
- **è¡¨å•ä¸­å¿ƒæ¨¡å¼é¡µé¢**ï¼š`WorkflowFormPage.vue`
- **APIæ¥å£å°è£…**ï¼š`workflow.ts`
- **TypeScriptç±»å‹å®šä¹‰**ï¼šå®Œæ•´çš„ç±»å‹æ”¯æŒ

#### 1.3 æ•°æ®åº“è¡¨ç»“æ„
- **å·¥ä½œæµé…ç½®è¡¨**ï¼š`onl_cgform_workflow_config`
- **èŠ‚ç‚¹æƒé™é…ç½®è¡¨**ï¼š`onl_cgform_workflow_node`

## 2. æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### 2.1 æ™ºèƒ½é»˜è®¤æƒé™ç­–ç•¥

**å·¥ä½œåŸç†ï¼š**
- è‡ªåŠ¨è¯†åˆ«ä¸šåŠ¡å­—æ®µ vs é€šç”¨æµç¨‹å­—æ®µ
- å‘èµ·èŠ‚ç‚¹ï¼šä¸šåŠ¡å­—æ®µå¯ç¼–è¾‘
- å…¶ä»–èŠ‚ç‚¹ï¼šä¸šåŠ¡å­—æ®µåªè¯»ï¼Œæµç¨‹å­—æ®µå¯ç¼–è¾‘

**å­—æ®µè¯†åˆ«è§„åˆ™ï¼š**
```java
// é€šç”¨æµç¨‹å­—æ®µè¯†åˆ«
audit_*      // å®¡æ ¸ç›¸å…³
approve_*    // å®¡æ‰¹ç›¸å…³  
process_*    // å¤„ç†ç›¸å…³
*_opinion    // æ„è§å­—æ®µ
*_comment    // è¯„è®ºå­—æ®µ
*_remark     // å¤‡æ³¨å­—æ®µ
```

### 2.2 è¡¨å•æ˜¾ç¤ºæ¨¡å¼

**ä¸‰ç§æ™ºèƒ½æ¨¡å¼ï¼š**
- **OPERATEæ¨¡å¼**ï¼šç”¨æˆ·æœ‰å½“å‰ä»»åŠ¡ï¼Œå¯ç¼–è¾‘æ“ä½œ
- **TRACKæ¨¡å¼**ï¼šæµç¨‹è¿›è¡Œä¸­ä½†ç”¨æˆ·æ— ä»»åŠ¡ï¼Œåªè¯»è·Ÿè¸ª
- **VIEWæ¨¡å¼**ï¼šæµç¨‹ç»“æŸæˆ–æœªå¼€å§‹ï¼ŒæŸ¥çœ‹å†å²

### 2.3 ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶

**åŸºäºFlowableå˜é‡å­˜å‚¨ï¼š**
- æ¯ä¸ªèŠ‚ç‚¹å®Œæˆæ—¶è‡ªåŠ¨ä¿å­˜å¿«ç…§
- å­˜å‚¨åˆ°æµç¨‹å˜é‡ä¸­ï¼š`form_snapshot_{nodeCode}`
- æ”¯æŒç‰ˆæœ¬å¯¹æ¯”å’Œå†å²è¿½æº¯

## 3. ä½¿ç”¨æŒ‡å—

### 3.1 é…ç½®å·¥ä½œæµè¡¨å•

#### æ­¥éª¤1ï¼šåˆ›å»ºä¸šåŠ¡è¡¨
```sql
CREATE TABLE maintenance_report (
  id varchar(32) PRIMARY KEY,
  title varchar(200) NOT NULL,
  description text,
  priority INTEGER DEFAULT 1,
  
  -- å·¥ä½œæµé›†æˆå­—æ®µ
  process_instance_id varchar(64),
  bmp_status varchar(20) DEFAULT 'DRAFT',
  
  -- é€šç”¨æµç¨‹å­—æ®µ
  audit_opinion text,
  process_comment text,
  
  create_by varchar(32),
  create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### æ­¥éª¤2ï¼šé…ç½®å·¥ä½œæµå…³è”
```java
// è°ƒç”¨APIé…ç½®å·¥ä½œæµ
POST /workflow/onlCgformWorkflowConfig/add
{
  "cgformHeadId": "form_123",
  "processDefinitionKey": "maintenance_process",
  "workflowEnabled": true,
  "versionControlEnabled": true,
  "permissionControlEnabled": true,
  "statusField": "bmp_status",
  "processInstanceField": "process_instance_id"
}
```

### 3.2 å‰ç«¯é¡µé¢ä½¿ç”¨

#### æ–¹å¼1ï¼šç›´æ¥ä½¿ç”¨ç»„ä»¶
```vue
<template>
  <WorkflowFormPage 
    :formId="'maintenance_form'"
    :dataId="dataId"
    :taskId="taskId"
  />
</template>

<script setup>
import WorkflowFormPage from '@/views/workflow/components/WorkflowFormPage.vue';
</script>
```

#### æ–¹å¼2ï¼šè·¯ç”±è®¿é—®
```javascript
// æ–°å»ºè¡¨å•
/workflow/form/maintenance-report

// æŸ¥çœ‹è¡¨å•  
/workflow/form/maintenance-report/123456

// å¤„ç†ä»»åŠ¡
/workflow/form/maintenance-report/123456?taskId=task001
```

### 3.3 APIè°ƒç”¨ç¤ºä¾‹

#### å¯åŠ¨å·¥ä½œæµ
```javascript
import { startWorkflow } from '@/api/workflow';

const result = await startWorkflow({
  formId: 'maintenance_form',
  dataId: 'report_001', 
  formData: {
    title: 'ç©ºè°ƒç»´ä¿®ç”³è¯·',
    description: 'åŠå…¬å®¤ç©ºè°ƒä¸åˆ¶å†·',
    priority: 2
  }
});
```

#### è·å–æ˜¾ç¤ºæ¨¡å¼
```javascript
import { getDisplayMode } from '@/api/workflow';

const displayMode = await getDisplayMode({
  formId: 'maintenance_form',
  dataId: 'report_001'
});

console.log('å½“å‰æ¨¡å¼:', displayMode.mode);
console.log('æ˜¯å¦æœ‰ä»»åŠ¡:', displayMode.hasCurrentTask);
```

## 4. é«˜çº§é…ç½®

### 4.1 è‡ªå®šä¹‰æƒé™é…ç½®

**é€šè¿‡æ•°æ®åº“ç›´æ¥é…ç½®ï¼š**
```sql
INSERT INTO onl_cgform_workflow_node (
  cgform_head_id, process_definition_key, node_id, node_name,
  editable_fields, readonly_fields, required_fields
) VALUES (
  'form_123', 'maintenance_process', 'approve_node', 'éƒ¨é—¨å®¡æ ¸',
  '["audit_opinion", "approve_result"]',
  '["title", "description", "priority"]', 
  '["audit_opinion"]'
);
```

### 4.2 æ‰©å±•å­—æ®µè¯†åˆ«è§„åˆ™

**è‡ªå®šä¹‰å­—æ®µåˆ†ç±»ï¼š**
```java
@Component
public class CustomFieldStrategy extends DefaultFieldPermissionStrategy {
    
    @Override
    public boolean isCommonProcessField(String fieldName, String comment) {
        // è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘
        if (fieldName.contains("custom_")) {
            return true;
        }
        return super.isCommonProcessField(fieldName, comment);
    }
}
```

## 5. ç›‘æ§å’Œç»´æŠ¤

### 5.1 æ—¥å¿—æŸ¥çœ‹

**å…³é”®æ—¥å¿—çº§åˆ«ï¼š**
```yaml
logging:
  level:
    org.jeecg.modules.workflow: DEBUG
```

**ç›‘æ§è¦ç‚¹ï¼š**
- æƒé™éªŒè¯æ—¥å¿—
- å·¥ä½œæµå¯åŠ¨/å®Œæˆæ—¥å¿—  
- å¿«ç…§ä¿å­˜æ—¥å¿—
- æ˜¾ç¤ºæ¨¡å¼è®¡ç®—æ—¥å¿—

### 5.2 æ€§èƒ½ä¼˜åŒ–

**ç¼“å­˜é…ç½®ï¼š**
```java
@Cacheable("workflow-permission")
public FormPermissionConfig getNodePermission(String formId, String nodeId) {
    // æƒé™é…ç½®ç¼“å­˜
}
```

**æ•°æ®åº“ä¼˜åŒ–ï¼š**
```sql
-- å…³é”®ç´¢å¼•
CREATE INDEX idx_workflow_config_form ON onl_cgform_workflow_config(cgform_head_id);
CREATE INDEX idx_workflow_node_form_node ON onl_cgform_workflow_node(cgform_head_id, node_id);
```

## 6. æ•…éšœæ’æŸ¥

### 6.1 å¸¸è§é—®é¢˜

**é—®é¢˜1ï¼šæƒé™é…ç½®ä¸ç”Ÿæ•ˆ**
```bash
# æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
SELECT * FROM onl_cgform_workflow_node WHERE cgform_head_id = 'your_form_id';

# æ£€æŸ¥é»˜è®¤ç­–ç•¥æ—¥å¿—
grep "æ™ºèƒ½é»˜è®¤ç­–ç•¥" logs/jeecg-boot.log
```

**é—®é¢˜2ï¼šå·¥ä½œæµå¯åŠ¨å¤±è´¥**
```bash
# æ£€æŸ¥Flowableé…ç½®
SELECT * FROM onl_cgform_workflow_config WHERE cgform_head_id = 'your_form_id';

# æ£€æŸ¥æµç¨‹å®šä¹‰
SELECT * FROM ACT_RE_PROCDEF WHERE KEY_ = 'your_process_key';
```

### 6.2 è°ƒè¯•å·¥å…·

**APIæµ‹è¯•ï¼š**
```bash
# æµ‹è¯•æ˜¾ç¤ºæ¨¡å¼
curl -X GET "http://localhost:8080/jeecg-boot/workflow/form/display-mode?formId=test_form&dataId=123"

# æµ‹è¯•æƒé™é…ç½®  
curl -X GET "http://localhost:8080/jeecg-boot/workflow/form/node-permission?formId=test_form&nodeId=start"
```

## 7. ä¸‹ä¸€æ­¥è®¡åˆ’

### 7.1 å¾…å®ç°åŠŸèƒ½
- [ ] Flowableè®¾è®¡å™¨æƒé™é…ç½®æ‰©å±•
- [ ] åœ¨çº¿è¡¨å•ç»„ä»¶æ·±åº¦é›†æˆ
- [ ] ç‰ˆæœ¬å¯¹æ¯”å¯è§†åŒ–ç•Œé¢
- [ ] å·¥ä½œæµè¡¨å•æ¨¡æ¿å¸‚åœº

### 7.2 æ€§èƒ½ä¼˜åŒ–
- [ ] å¤§è¡¨å•å¿«ç…§å‹ç¼©ç®—æ³•
- [ ] æƒé™é…ç½®ç¼“å­˜ç­–ç•¥
- [ ] æ•°æ®åº“åˆ†åŒºä¼˜åŒ–
- [ ] å‰ç«¯è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–

---

**ğŸ‰ å½“å‰å®ç°å·²è¦†ç›–ç¬¬ä¸€é˜¶æ®µçš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå¯ä»¥å¼€å§‹ä¸šåŠ¡é›†æˆå’Œæµ‹è¯•ï¼**

å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚