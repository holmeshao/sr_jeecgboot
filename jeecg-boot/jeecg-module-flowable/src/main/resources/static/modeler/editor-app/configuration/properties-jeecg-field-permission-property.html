<!--
ğŸ¯ ç”¨æˆ·ä»»åŠ¡å±æ€§é¢æ¿ä¸­çš„å­—æ®µæƒé™é…ç½®é¡¹
æ·»åŠ åˆ°Flowableè®¾è®¡å™¨çš„ç”¨æˆ·ä»»åŠ¡å±æ€§é¢æ¿ä¸­
-->

<div class="property" ng-controller="JeecgFieldPermissionCtrl">
    
    <!-- å­—æ®µæƒé™é…ç½®å…¥å£ -->
    <div class="jeecg-field-permission-property">
        
        <!-- é…ç½®æŒ‰é’®åŒºåŸŸ -->
        <div class="form-group">
            <label translate="PROPERTY.FIELDPERMISSION.TITLE">å­—æ®µæƒé™é…ç½®</label>
            <div class="form-control-container">
                <button type="button" 
                        class="btn btn-primary btn-sm btn-block"
                        ng-click="openFieldPermissionPanel()"
                        ng-disabled="!selectedShape.properties.formkey">
                    <i class="fa fa-lock"></i>
                    é…ç½®å­—æ®µæƒé™
                </button>
                
                <!-- è¡¨å•Keyæç¤º -->
                <div ng-if="!selectedShape.properties.formkey" class="help-block text-warning">
                    <i class="fa fa-warning"></i>
                    è¯·å…ˆåœ¨"è¡¨å•"é€‰é¡¹å¡ä¸­é…ç½®è¡¨å•Key
                </div>
                
                <!-- æƒé™æ‘˜è¦æ˜¾ç¤º -->
                <div ng-if="selectedShape.properties.formkey && hasFieldPermissions()" class="field-permission-summary">
                    <small class="text-muted">
                        <i class="fa fa-info-circle"></i>
                        {{ getExistingPermissionSummary() }}
                    </small>
                </div>
            </div>
        </div>
        
        <!-- å¿«é€Ÿæ“ä½œåŒºåŸŸ -->
        <div class="form-group" ng-if="selectedShape.properties.formkey">
            <label>å¿«é€Ÿæ“ä½œ</label>
            <div class="btn-group btn-group-xs btn-group-justified" role="group">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default" ng-click="quickApplySmartDefaults()">
                        <i class="fa fa-magic"></i> æ™ºèƒ½é»˜è®¤
                    </button>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default" ng-click="quickClearPermissions()">
                        <i class="fa fa-eraser"></i> æ¸…é™¤é…ç½®
                    </button>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- æƒé™é…ç½®å¼¹çª— -->
    <div class="modal fade" id="fieldPermissionModal" ng-show="showPermissionPanel" style="display: block;">
        <div class="modal-dialog modal-lg">
            <div ng-include="'configuration/properties-jeecg-field-permission-popup.html'"></div>
        </div>
    </div>
    
    <!-- é®ç½©å±‚ -->
    <div class="modal-backdrop fade in" ng-show="showPermissionPanel"></div>
    
</div>

<script>
// ğŸ¯ æ‰©å±•ç°æœ‰çš„ç”¨æˆ·ä»»åŠ¡å±æ€§æ§åˆ¶å™¨
angular.module('flowableModeler').controller('JeecgFieldPermissionCtrl', ['$rootScope', '$scope', '$http', 
function ($rootScope, $scope, $http) {
    
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å­—æ®µæƒé™é…ç½®
    $scope.hasFieldPermissions = function() {
        try {
            var extensionElements = $scope.selectedShape.properties.extensionelements;
            if (extensionElements && extensionElements.values) {
                return extensionElements.values.some(function(ext) {
                    return ext.elementType === 'jeecg:fieldPermissions';
                });
            }
            return false;
        } catch (error) {
            return false;
        }
    };
    
    // è·å–ç°æœ‰æƒé™é…ç½®æ‘˜è¦
    $scope.getExistingPermissionSummary = function() {
        try {
            var extensionElements = $scope.selectedShape.properties.extensionelements;
            if (extensionElements && extensionElements.values) {
                var fieldPermissions = extensionElements.values.find(function(ext) {
                    return ext.elementType === 'jeecg:fieldPermissions';
                });
                
                if (fieldPermissions) {
                    var editableCount = 0, readonlyCount = 0, hiddenCount = 0, requiredCount = 0;
                    
                    try {
                        if (fieldPermissions.editableFields) {
                            editableCount = JSON.parse(fieldPermissions.editableFields).length;
                        }
                        if (fieldPermissions.readonlyFields) {
                            readonlyCount = JSON.parse(fieldPermissions.readonlyFields).length;
                        }
                        if (fieldPermissions.hiddenFields) {
                            hiddenCount = JSON.parse(fieldPermissions.hiddenFields).length;
                        }
                        if (fieldPermissions.requiredFields) {
                            requiredCount = JSON.parse(fieldPermissions.requiredFields).length;
                        }
                    } catch (e) {
                        return 'æƒé™é…ç½®è§£æé”™è¯¯';
                    }
                    
                    return `å·²é…ç½®: å¯ç¼–è¾‘${editableCount} | åªè¯»${readonlyCount} | éšè—${hiddenCount} | å¿…å¡«${requiredCount}`;
                }
            }
            return 'æœªé…ç½®æƒé™';
        } catch (error) {
            return 'æƒé™é…ç½®è¯»å–é”™è¯¯';
        }
    };
    
    // å¿«é€Ÿåº”ç”¨æ™ºèƒ½é»˜è®¤
    $scope.quickApplySmartDefaults = function() {
        if (!$scope.selectedShape.properties.formkey) {
            alert('è¯·å…ˆé…ç½®è¡¨å•Key');
            return;
        }
        
        // æ‰“å¼€é…ç½®é¢æ¿å¹¶åº”ç”¨æ™ºèƒ½é»˜è®¤
        $scope.openFieldPermissionPanel();
        // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿å­—æ®µå·²åŠ è½½
        setTimeout(function() {
            if ($scope.formFieldsLoaded) {
                $scope.applySmartDefaults();
                $scope.$apply();
            }
        }, 1000);
    };
    
    // å¿«é€Ÿæ¸…é™¤æƒé™é…ç½®
    $scope.quickClearPermissions = function() {
        if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­—æ®µæƒé™é…ç½®å—ï¼Ÿ')) {
            return;
        }
        
        try {
            var extensionElements = $scope.selectedShape.properties.extensionelements;
            if (extensionElements && extensionElements.values) {
                extensionElements.values = extensionElements.values.filter(function(ext) {
                    return ext.elementType !== 'jeecg:fieldPermissions';
                });
                
                // è§¦å‘å±æ€§æ›´æ–°
                $rootScope.$broadcast('property-value-changed', {
                    element: $scope.selectedShape,
                    property: 'fieldPermissions',
                    oldValue: 'configured',
                    newValue: null
                });
                
                alert('å­—æ®µæƒé™é…ç½®å·²æ¸…é™¤');
            }
        } catch (error) {
            console.error('æ¸…é™¤æƒé™é…ç½®å¤±è´¥:', error);
            alert('æ¸…é™¤å¤±è´¥: ' + error.message);
        }
    };
    
}]);
</script>

<style>
.jeecg-field-permission-property {
    padding: 10px 0;
}

.field-permission-summary {
    margin-top: 8px;
    padding: 6px;
    background-color: #f0f9ff;
    border: 1px solid #b3e5fc;
    border-radius: 3px;
}

.field-permission-summary .text-muted {
    color: #607d8b !important;
}

/* å¿«é€Ÿæ“ä½œæŒ‰é’®æ ·å¼ */
.btn-group-justified .btn-group .btn {
    border-radius: 0;
}

.btn-group-justified .btn-group:first-child .btn {
    border-top-left-radius: 4px;
    border-bottom-left-radius: 4px;
}

.btn-group-justified .btn-group:last-child .btn {
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
}

/* æ¨¡æ€æ¡†æ ·å¼è°ƒæ•´ */
.modal {
    z-index: 9999;
}

.modal-backdrop {
    z-index: 9998;
}

/* å±æ€§é¢æ¿å†…çš„æŒ‰é’®æ ·å¼ */
.property .btn-block {
    margin-bottom: 8px;
}

.property .help-block {
    margin-top: 5px;
    margin-bottom: 0;
    font-size: 12px;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .btn-group-justified {
        display: block;
    }
    
    .btn-group-justified .btn-group {
        display: block;
        float: none;
        width: 100%;
        margin-bottom: 5px;
    }
    
    .btn-group-justified .btn-group .btn {
        width: 100%;
        border-radius: 4px !important;
    }
}
</style>