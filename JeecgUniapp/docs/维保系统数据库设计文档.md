# 维保系统数据库设计文档

## 1. 设计理念与架构

### 1.1 核心设计思路

本维保系统采用**轻度使用Flowable + 节点数据版本化存储**的架构模式，核心理念如下：

1. **业务数据与流程控制分离**：Flowable专注于流程控制，业务数据独立存储管理
2. **版本化数据存储**：支持业务数据的反复修改和完整历史追溯
3. **节点化附件管理**：按流程节点和业务类别组织附件存储
4. **灵活的权限控制**：基于JeecgBoot现有权限体系扩展项目级权限

### 1.2 技术架构优势

- **扩展性强**：新增业务数据类型无需修改流程定义
- **数据安全**：业务数据独立于工作流引擎，确保数据完整性
- **性能优化**：复杂业务查询不依赖工作流API，查询效率高
- **维护便利**：业务逻辑与流程逻辑解耦，便于独立维护

### 1.3 流程节点设计

```
报备提交(SUBMIT) → 待确认(CONFIRM) → 派单分配(ASSIGN) → 维修执行(REPAIR) → 验收完成(ACCEPT) → 已完成(COMPLETED)
                                    ↓
                                  可退回到任意前置节点
```

### 1.4 数据层次结构

```
1. 基础数据层：客户、项目、用户、部门等主数据
2. 业务核心层：维修工单主表（核心业务信息）
3. 流程数据层：节点业务数据、流程日志、附件管理
4. 统计分析层：基于核心数据的多维度统计视图
```

## 2. 数据库表结构设计

### 2.1 基础数据表

#### 2.1.1 客户信息表
```sql
CREATE TABLE `customer_info` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `customer_name` varchar(200) NOT NULL COMMENT '客户名称',
  `customer_type` varchar(20) NOT NULL DEFAULT 'PROPERTY' COMMENT '客户类型(PROPERTY物业公司,DEVELOPER开发商)',
  `customer_code` varchar(50) COMMENT '客户编码',
  `contact_person` varchar(100) COMMENT '联系人',
  `contact_phone` varchar(20) COMMENT '联系电话',
  `contact_email` varchar(100) COMMENT '联系邮箱',
  `address` varchar(500) COMMENT '客户地址',
  `related_community` varchar(500) COMMENT '关联小区',
  
  -- 登录相关（支持客户直接登录小程序）
  `login_username` varchar(50) COMMENT '登录账号',
  `login_password` varchar(100) COMMENT '登录密码（加密存储）',
  `login_phone` varchar(20) COMMENT '登录手机号',
  
  -- 状态控制
  `status` tinyint(1) DEFAULT 1 COMMENT '状态(1正常 0禁用)',
  `remark` text COMMENT '备注',
  
  -- 系统字段
  `tenant_id` int COMMENT '租户ID',
  `create_by` varchar(32) COMMENT '创建人',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_by` varchar(32) COMMENT '更新人',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_customer_code` (`customer_code`),
  UNIQUE KEY `uk_login_username` (`login_username`),
  UNIQUE KEY `uk_login_phone` (`login_phone`),
  KEY `idx_customer_type` (`customer_type`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='客户信息表';
```

#### 2.1.2 项目信息表
```sql
CREATE TABLE `project_info` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `project_name` varchar(200) NOT NULL COMMENT '项目名称',
  `project_code` varchar(50) NOT NULL COMMENT '项目编码',
  `customer_id` varchar(32) NOT NULL COMMENT '客户ID',
  
  -- 项目时间管理
  `construction_start_date` date COMMENT '建设开始日期',
  `construction_end_date` date COMMENT '建设结束日期',
  `handover_date` date COMMENT '交付日期',
  `warranty_start_date` date COMMENT '质保开始日期',
  `warranty_months` int DEFAULT 24 COMMENT '质保期（月数）',
  
  -- 项目管理
  `project_manager_id` varchar(32) COMMENT '项目负责人ID',
  `manager_name` varchar(100) COMMENT '负责人姓名',
  `manager_phone` varchar(20) COMMENT '负责人联系电话',
  `project_address` varchar(500) COMMENT '项目地址',
  `project_area` decimal(10,2) COMMENT '项目面积（平方米）',
  `building_count` int COMMENT '建筑栋数',
  
  -- 项目描述
  `project_desc` text COMMENT '项目描述',
  `construction_unit` varchar(200) COMMENT '施工单位',
  `supervision_unit` varchar(200) COMMENT '监理单位',
  
  -- 状态控制
  `project_status` varchar(20) DEFAULT 'NORMAL' COMMENT '项目状态(NORMAL正常,SUSPENDED暂停,COMPLETED已完工,CANCELLED已取消)',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态(1正常 0禁用)',
  
  -- 系统字段
  `tenant_id` int COMMENT '租户ID',
  `create_by` varchar(32) COMMENT '创建人',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_by` varchar(32) COMMENT '更新人',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_project_code` (`project_code`),
  KEY `idx_customer_id` (`customer_id`),
  KEY `idx_project_manager` (`project_manager_id`),
  KEY `idx_project_status` (`project_status`),
  KEY `idx_warranty_date` (`warranty_start_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='项目信息表';
```

#### 2.1.3 问题类型字典表
```sql
CREATE TABLE `problem_type_dict` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `type_name` varchar(100) NOT NULL COMMENT '问题类型名称',
  `type_code` varchar(50) NOT NULL COMMENT '问题类型编码',
  `parent_id` varchar(32) COMMENT '父级ID（支持二级分类）',
  `icon` varchar(100) COMMENT '图标',
  `sort_order` int DEFAULT 0 COMMENT '排序',
  `description` varchar(500) COMMENT '描述',
  `is_urgent` tinyint(1) DEFAULT 0 COMMENT '是否紧急类型',
  `estimated_hours` int COMMENT '预估处理时长（小时）',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态(1启用 0禁用)',
  `create_by` varchar(32) COMMENT '创建人',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_by` varchar(32) COMMENT '更新人',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_type_code` (`type_code`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_sort_order` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='问题类型字典表';
```

### 2.2 核心业务表

#### 2.2.1 维修报备主表（核心表）
```sql
CREATE TABLE `maintenance_report` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `report_no` varchar(50) NOT NULL COMMENT '报备编号（自动生成）',
  `project_id` varchar(32) NOT NULL COMMENT '项目ID',
  `customer_id` varchar(32) NOT NULL COMMENT '客户ID',
  `problem_type_id` varchar(32) NOT NULL COMMENT '问题类型ID',
  
  -- 报备基本信息
  `title` varchar(200) NOT NULL COMMENT '报备标题',
  `description` text NOT NULL COMMENT '问题描述',
  `urgency_level` tinyint(1) DEFAULT 1 COMMENT '紧急程度(1普通 2紧急 3特急)',
  `problem_location` varchar(500) COMMENT '问题位置（详细地址）',
  `building_info` varchar(200) COMMENT '楼栋信息',
  `unit_info` varchar(100) COMMENT '单元信息',
  
  -- 质保期判断（提交时计算确定，不可变更）
  `is_in_warranty` tinyint(1) NOT NULL COMMENT '是否质保期内(1是 0否)',
  `warranty_end_date` date COMMENT '质保截止日期（快照）',
  
  -- 轻量级工作流字段
  `workflow_instance_id` varchar(64) COMMENT 'Flowable流程实例ID',
  `current_node_code` varchar(50) COMMENT '当前节点编码',
  `current_task_id` varchar(64) COMMENT '当前任务ID',
  `current_assignee_id` varchar(32) COMMENT '当前处理人ID',
  `current_assignee_name` varchar(100) COMMENT '当前处理人姓名',
  
  -- 业务状态（与工作流状态同步）
  `status` varchar(20) DEFAULT 'DRAFT' COMMENT '状态(DRAFT草稿,SUBMITTED已提交,CONFIRMED已确认,ASSIGNED已派单,REPAIRING维修中,COMPLETED已完成,REJECTED已拒绝,CANCELLED已取消)',
  `bpm_status` varchar(20) COMMENT '流程状态',
  
  -- 关键时间节点
  `submit_time` datetime COMMENT '提交时间',
  `confirm_time` datetime COMMENT '确认时间',
  `assign_time` datetime COMMENT '派单时间',
  `repair_start_time` datetime COMMENT '开始维修时间',
  `repair_complete_time` datetime COMMENT '维修完成时间',
  `accept_time` datetime COMMENT '验收时间',
  `complete_time` datetime COMMENT '最终完成时间',
  `expected_complete_time` datetime COMMENT '预计完成时间',
  
  -- 指派信息
  `assigned_team_id` varchar(32) COMMENT '指派班组ID',
  `assigned_team_name` varchar(100) COMMENT '指派班组名称',
  
  -- 最终结果汇总（从节点数据表同步）
  `final_cost` decimal(10,2) COMMENT '最终费用',
  `satisfaction_score` tinyint(1) COMMENT '满意度评分(1-5)',
  `overall_evaluation` text COMMENT '整体评价',
  
  -- 统计字段
  `total_hours` int COMMENT '总耗时（小时）',
  `delay_hours` int COMMENT '延期时长（小时）',
  
  -- 系统字段
  `tenant_id` int COMMENT '租户ID',
  `create_by` varchar(32) COMMENT '创建人',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_by` varchar(32) COMMENT '更新人',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_report_no` (`report_no`),
  KEY `idx_project_id` (`project_id`),
  KEY `idx_customer_id` (`customer_id`),
  KEY `idx_status` (`status`),
  KEY `idx_submit_time` (`submit_time`),
  KEY `idx_workflow_instance` (`workflow_instance_id`),
  KEY `idx_current_assignee` (`current_assignee_id`),
  KEY `idx_problem_type` (`problem_type_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='维修报备主表';
```

### 2.3 流程数据表（核心设计）

#### 2.3.1 流程节点业务数据表
```sql
CREATE TABLE `report_node_data` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `report_id` varchar(32) NOT NULL COMMENT '工单ID',
  `task_id` varchar(64) COMMENT 'Flowable任务ID',
  `execution_id` varchar(64) COMMENT 'Flowable执行ID',
  
  -- 节点标识
  `node_code` varchar(50) NOT NULL COMMENT '节点编码(SUBMIT提交,CONFIRM确认,ASSIGN派单,REPAIR维修,ACCEPT验收)',
  `node_name` varchar(100) COMMENT '节点名称',
  
  -- 数据分类
  `data_type` varchar(50) NOT NULL COMMENT '数据类型(PLAN维修方案,COST费用,MATERIALS材料,RESULT结果,EVALUATION评价)',
  `data_category` varchar(50) COMMENT '数据分类（细分类别）',
  
  -- 数据内容（JSON格式存储）
  `data_content` text NOT NULL COMMENT '数据内容（JSON格式）',
  `data_summary` varchar(500) COMMENT '数据摘要（便于快速查看）',
  
  -- 版本控制（支持反复修改）
  `version` int DEFAULT 1 COMMENT '版本号',
  `is_current` tinyint(1) DEFAULT 1 COMMENT '是否当前版本(1是 0否)',
  `is_submitted` tinyint(1) DEFAULT 0 COMMENT '是否已提交(1是 0草稿)',
  
  -- 操作信息
  `operator_id` varchar(32) NOT NULL COMMENT '操作人ID',
  `operator_name` varchar(100) COMMENT '操作人姓名',
  `operate_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  `remark` text COMMENT '备注说明',
  
  -- 状态控制
  `status` varchar(20) DEFAULT 'NORMAL' COMMENT '状态(NORMAL正常,CANCELLED已取消)',
  
  PRIMARY KEY (`id`),
  KEY `idx_report_task` (`report_id`, `task_id`),
  KEY `idx_node_data_type` (`node_code`, `data_type`),
  KEY `idx_report_current` (`report_id`, `is_current`),
  KEY `idx_operator_time` (`operator_id`, `operate_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程节点业务数据表';
```

#### 2.3.2 流程操作日志表
```sql
CREATE TABLE `report_process_log` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `report_id` varchar(32) NOT NULL COMMENT '工单ID',
  `task_id` varchar(64) COMMENT '任务ID',
  `execution_id` varchar(64) COMMENT '执行ID',
  `process_instance_id` varchar(64) COMMENT '流程实例ID',
  
  -- 流程节点信息
  `activity_id` varchar(100) COMMENT '活动ID',
  `activity_name` varchar(200) COMMENT '活动名称',
  `from_node_code` varchar(50) COMMENT '来源节点编码',
  `to_node_code` varchar(50) COMMENT '目标节点编码',
  
  -- 操作信息
  `action_type` varchar(50) NOT NULL COMMENT '操作类型(SUBMIT提交,COMPLETE完成,REJECT拒绝,DELEGATE委派,CLAIM认领,UNCLAIM取消认领)',
  `operator_id` varchar(32) NOT NULL COMMENT '操作人ID',
  `operator_name` varchar(100) COMMENT '操作人姓名',
  `operate_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  
  -- 操作内容
  `operation_comment` text COMMENT '操作意见',
  `variables_snapshot` text COMMENT '流程变量快照（JSON）',
  
  -- 耗时统计
  `duration_millis` bigint COMMENT '任务耗时（毫秒）',
  
  PRIMARY KEY (`id`),
  KEY `idx_report_id` (`report_id`),
  KEY `idx_task_id` (`task_id`),
  KEY `idx_operator_time` (`operator_id`, `operate_time`),
  KEY `idx_process_instance` (`process_instance_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='流程操作日志表';
```

### 2.4 附件管理表

#### 2.4.1 报备附件表
```sql
CREATE TABLE `report_attachment` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `report_id` varchar(32) NOT NULL COMMENT '工单ID',
  `task_id` varchar(64) COMMENT '任务ID（关联具体节点）',
  `node_data_id` varchar(32) COMMENT '节点数据ID（关联具体业务数据）',
  
  -- 节点和分类
  `node_code` varchar(50) NOT NULL COMMENT '节点编码',
  `attachment_category` varchar(50) NOT NULL COMMENT '附件分类(PROBLEM问题图片,PLAN方案图片,PROGRESS进度图片,RESULT结果图片,MATERIAL材料图片)',
  
  -- 文件信息
  `file_name` varchar(200) NOT NULL COMMENT '文件名',
  `original_name` varchar(200) COMMENT '原始文件名',
  `file_path` varchar(500) NOT NULL COMMENT '文件路径',
  `file_url` varchar(500) COMMENT '访问URL',
  `file_type` varchar(20) NOT NULL COMMENT '文件类型(IMAGE图片,VIDEO视频,DOCUMENT文档,AUDIO音频)',
  `file_extension` varchar(10) COMMENT '文件扩展名',
  `file_size` bigint COMMENT '文件大小（字节）',
  `file_md5` varchar(32) COMMENT '文件MD5值（防重复上传）',
  
  -- 图片专用字段
  `image_width` int COMMENT '图片宽度',
  `image_height` int COMMENT '图片高度',
  `thumbnail_path` varchar(500) COMMENT '缩略图路径',
  
  -- 描述信息
  `file_desc` varchar(500) COMMENT '文件描述',
  `sort_order` int DEFAULT 0 COMMENT '排序',
  
  -- 状态控制
  `is_deleted` tinyint(1) DEFAULT 0 COMMENT '是否删除(1是 0否)',
  `delete_time` datetime COMMENT '删除时间',
  `status` varchar(20) DEFAULT 'NORMAL' COMMENT '状态(NORMAL正常,PROCESSING处理中,FAILED失败)',
  
  -- 上传信息
  `upload_by` varchar(32) NOT NULL COMMENT '上传人ID',
  `upload_name` varchar(100) COMMENT '上传人姓名',
  `upload_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `upload_ip` varchar(50) COMMENT '上传IP',
  
  PRIMARY KEY (`id`),
  KEY `idx_report_node` (`report_id`, `node_code`),
  KEY `idx_task_id` (`task_id`),
  KEY `idx_node_data_id` (`node_data_id`),
  KEY `idx_file_md5` (`file_md5`),
  KEY `idx_upload_by` (`upload_by`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='报备附件表';
```

### 2.5 人员组织表

#### 2.5.1 劳务班组表
```sql
CREATE TABLE `labor_team` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `team_name` varchar(100) NOT NULL COMMENT '班组名称',
  `team_code` varchar(50) NOT NULL COMMENT '班组编码',
  `team_type` varchar(50) COMMENT '班组类型(PLUMBING水电,PAINT装修,CLEAN保洁,GARDEN绿化,SECURITY安保)',
  
  -- 负责人信息
  `leader_id` varchar(32) COMMENT '负责人ID（关联sys_user）',
  `leader_name` varchar(100) COMMENT '负责人姓名',
  `leader_phone` varchar(20) COMMENT '负责人电话',
  
  -- 班组能力
  `skill_tags` varchar(500) COMMENT '技能标签（JSON格式：["水管维修","电路检修"]）',
  `service_areas` varchar(500) COMMENT '服务区域（JSON格式）',
  `max_concurrent_orders` int DEFAULT 5 COMMENT '最大并发工单数',
  `member_count` int DEFAULT 0 COMMENT '成员数量',
  
  -- 评价信息
  `avg_rating` decimal(3,2) DEFAULT 5.00 COMMENT '平均评分',
  `total_orders` int DEFAULT 0 COMMENT '总接单数',
  `completed_orders` int DEFAULT 0 COMMENT '已完成工单数',
  
  -- 状态控制
  `status` varchar(20) DEFAULT 'ACTIVE' COMMENT '状态(ACTIVE活跃,BUSY忙碌,INACTIVE不活跃,DISABLED禁用)',
  `remark` text COMMENT '备注',
  
  -- 系统字段
  `create_by` varchar(32) COMMENT '创建人',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_by` varchar(32) COMMENT '更新人',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_team_code` (`team_code`),
  KEY `idx_leader_id` (`leader_id`),
  KEY `idx_team_type` (`team_type`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='劳务班组表';
```

#### 2.5.2 班组成员表
```sql
CREATE TABLE `team_member` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `team_id` varchar(32) NOT NULL COMMENT '班组ID',
  `user_id` varchar(32) NOT NULL COMMENT '用户ID（关联sys_user）',
  `member_name` varchar(100) NOT NULL COMMENT '成员姓名',
  `member_phone` varchar(20) COMMENT '成员电话',
  `id_card` varchar(18) COMMENT '身份证号',
  
  -- 成员角色
  `member_role` varchar(20) DEFAULT 'MEMBER' COMMENT '成员角色(LEADER负责人,MEMBER普通成员,ASSISTANT助理)',
  `skill_level` varchar(20) DEFAULT 'JUNIOR' COMMENT '技能等级(JUNIOR初级,INTERMEDIATE中级,SENIOR高级,EXPERT专家)',
  `specialties` varchar(500) COMMENT '专业技能（JSON格式）',
  
  -- 成员状态
  `member_status` varchar(20) DEFAULT 'ACTIVE' COMMENT '成员状态(ACTIVE在职,LEAVE请假,QUIT离职)',
  `join_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
  `leave_time` datetime COMMENT '离开时间',
  
  -- 工作统计
  `total_orders` int DEFAULT 0 COMMENT '参与工单数',
  `avg_rating` decimal(3,2) DEFAULT 5.00 COMMENT '平均评分',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_team_user` (`team_id`, `user_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_member_status` (`member_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='班组成员表';
```

#### 2.5.3 员工项目关联表
```sql
CREATE TABLE `user_project_relation` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `user_id` varchar(32) NOT NULL COMMENT '用户ID（关联sys_user）',
  `project_id` varchar(32) NOT NULL COMMENT '项目ID',
  
  -- 角色权限
  `role_type` varchar(50) NOT NULL COMMENT '角色类型(PROJECT_MANAGER项目经理,MAINTENANCE_MANAGER维修主管,QUALITY_INSPECTOR质检员,MAINTENANCE_WORKER维修工人)',
  `permission_level` tinyint(1) DEFAULT 1 COMMENT '权限级别(1查看 2操作 3管理)',
  
  -- 关联信息
  `is_default_project` tinyint(1) DEFAULT 0 COMMENT '是否默认项目',
  `is_primary_role` tinyint(1) DEFAULT 1 COMMENT '是否主要角色',
  `assign_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '分配时间',
  `effective_start_date` date COMMENT '生效开始日期',
  `effective_end_date` date COMMENT '生效结束日期',
  
  -- 状态控制
  `status` varchar(20) DEFAULT 'ACTIVE' COMMENT '状态(ACTIVE有效,INACTIVE无效,EXPIRED已过期)',
  `remark` varchar(500) COMMENT '备注',
  
  -- 系统字段
  `create_by` varchar(32) COMMENT '创建人',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_by` varchar(32) COMMENT '更新人',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_project_role` (`user_id`, `project_id`, `role_type`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_project_id` (`project_id`),
  KEY `idx_role_type` (`role_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='员工项目关联表';
```

### 2.6 消息推送表

#### 2.6.1 系统消息表
```sql
CREATE TABLE `system_message` (
  `id` varchar(32) NOT NULL COMMENT '主键ID',
  `receiver_id` varchar(32) NOT NULL COMMENT '接收人ID',
  `receiver_type` varchar(20) NOT NULL COMMENT '接收人类型(USER员工,CUSTOMER客户)',
  
  -- 消息分类
  `message_type` varchar(50) NOT NULL COMMENT '消息类型(REPORT_STATUS报备状态,TASK_ASSIGN任务分配,SYSTEM_NOTICE系统通知,URGENT_ALERT紧急提醒)',
  `message_level` varchar(20) DEFAULT 'NORMAL' COMMENT '消息级别(LOW低,NORMAL普通,HIGH高,URGENT紧急)',
  
  -- 消息内容
  `title` varchar(200) NOT NULL COMMENT '消息标题',
  `content` text NOT NULL COMMENT '消息内容',
  `summary` varchar(500) COMMENT '消息摘要',
  
  -- 关联信息
  `related_type` varchar(50) COMMENT '关联类型(REPORT工单,PROJECT项目,SYSTEM系统)',
  `related_id` varchar(32) COMMENT '关联ID',
  `related_no` varchar(50) COMMENT '关联单号',
  
  -- 阅读状态
  `is_read` tinyint(1) DEFAULT 0 COMMENT '是否已读(1已读 0未读)',
  `read_time` datetime COMMENT '阅读时间',
  
  -- 推送状态
  `push_status` varchar(20) DEFAULT 'PENDING' COMMENT '推送状态(PENDING待推送,SUCCESS成功,FAILED失败,CANCELLED已取消)',
  `push_time` datetime COMMENT '推送时间',
  `push_platform` varchar(50) COMMENT '推送平台(WECHAT微信,SMS短信,EMAIL邮件,APP应用内)',
  `push_response` text COMMENT '推送响应',
  
  -- 有效期控制
  `expire_time` datetime COMMENT '过期时间',
  `is_expired` tinyint(1) DEFAULT 0 COMMENT '是否已过期',
  
  -- 系统字段
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  KEY `idx_receiver` (`receiver_id`, `receiver_type`),
  KEY `idx_message_type` (`message_type`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_related` (`related_type`, `related_id`),
  KEY `idx_unread` (`receiver_id`, `is_read`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统消息表';
```

## 3. 数据字典与配置

### 3.1 基础数据初始化

#### 3.1.1 问题类型初始化数据
```sql
-- 一级分类
INSERT INTO `problem_type_dict` VALUES 
('1', '水电问题', 'PLUMBING', NULL, 'water-drop', 1, '水管、电路相关问题', 1, 4, 1, 'system', NOW(), NULL, NULL),
('2', '装修问题', 'DECORATION', NULL, 'tool', 2, '墙面、地面、天花板等装修问题', 0, 8, 1, 'system', NOW(), NULL, NULL),
('3', '门窗问题', 'DOOR_WINDOW', NULL, 'door-open', 3, '门窗相关问题', 0, 2, 1, 'system', NOW(), NULL, NULL),
('4', '设备问题', 'EQUIPMENT', NULL, 'setting', 4, '设备设施相关问题', 1, 6, 1, 'system', NOW(), NULL, NULL),
('5', '其他问题', 'OTHER', NULL, 'question-circle', 5, '其他类型问题', 0, 4, 1, 'system', NOW(), NULL, NULL);

-- 二级分类
INSERT INTO `problem_type_dict` VALUES 
('11', '水管漏水', 'WATER_LEAK', '1', NULL, 1, '水管漏水、渗水问题', 1, 2, 1, 'system', NOW(), NULL, NULL),
('12', '电路故障', 'ELECTRICAL_FAULT', '1', NULL, 2, '电路断路、短路等问题', 1, 4, 1, 'system', NOW(), NULL, NULL),
('21', '墙面问题', 'WALL_ISSUE', '2', NULL, 1, '墙面开裂、脱落等', 0, 6, 1, 'system', NOW(), NULL, NULL),
('22', '地面问题', 'FLOOR_ISSUE', '2', NULL, 2, '地面破损、不平等', 0, 8, 1, 'system', NOW(), NULL, NULL);
```

### 3.2 系统角色权限配置

#### 3.2.1 角色类型说明
```sql
-- 角色类型配置参考
/*
系统共6种角色（基于需求文档）：
1. 系统管理员 (SYSTEM_ADMIN)
2. 物业公司 (PROPERTY_COMPANY) 
3. 维修人员 (MAINTENANCE_WORKER)
4. 劳务部 (LABOR_DEPARTMENT)
5. 项目经理 (PROJECT_MANAGER)
6. 主管级别 (SUPERVISOR)

权限矩阵：
- 报备管理：提交、查看、统计分析
- 工作台：待确认、待维修、待验收状态管理
- 人员管理：客户、项目、部门、员工、劳务班组
- 系统管理：角色权限、流程管理、系统配置
*/
```

## 4. 核心业务数据示例

### 4.1 节点数据JSON格式示例

#### 4.1.1 维修方案数据格式
```json
{
  "planType": "REPLACEMENT",
  "description": "更换损坏的水管接头",
  "estimatedCost": 500.00,
  "estimatedHours": 4,
  "materials": [
    {
      "name": "PVC水管",
      "specification": "φ20mm",
      "quantity": 2,
      "unit": "米",
      "unitPrice": 15.00
    },
    {
      "name": "管接头",
      "specification": "φ20mm",
      "quantity": 4,
      "unit": "个",
      "unitPrice": 5.00
    }
  ],
  "tools": ["扳手", "管钳", "切管器"],
  "riskAssessment": "低风险，不影响其他住户",
  "emergencyPlan": "如遇紧急情况立即停止作业并联系项目经理"
}
```

#### 4.1.2 维修结果数据格式
```json
{
  "repairStatus": "COMPLETED",
  "actualCost": 480.00,
  "actualHours": 3.5,
  "materialsUsed": [
    {
      "name": "PVC水管",
      "quantityUsed": 1.8,
      "costUsed": 27.00
    }
  ],
  "workSummary": "成功更换损坏的水管接头，测试无渗漏",
  "issuesEncountered": [],
  "qualityCheckPassed": true,
  "photos": ["photo1.jpg", "photo2.jpg"],
  "nextStepRecommendation": "建议3个月后回访检查"
}
```

### 4.2 查询示例

#### 4.2.1 获取工单当前维修方案
```sql
SELECT 
  rnd.data_content,
  rnd.version,
  rnd.operator_name,
  rnd.operate_time
FROM report_node_data rnd
WHERE rnd.report_id = 'R202412250001'
  AND rnd.node_code = 'ASSIGN'
  AND rnd.data_type = 'PLAN'
  AND rnd.is_current = 1;
```

#### 4.2.2 获取工单维修方案历史版本
```sql
SELECT 
  rnd.data_content,
  rnd.version,
  rnd.operator_name,
  rnd.operate_time,
  rnd.remark
FROM report_node_data rnd
WHERE rnd.report_id = 'R202412250001'
  AND rnd.node_code = 'ASSIGN'
  AND rnd.data_type = 'PLAN'
ORDER BY rnd.version DESC;
```

## 5. 总结

### 5.1 架构优势总结

1. **数据安全性**：业务数据与工作流引擎分离，确保数据安全
2. **扩展性强**：新增节点数据类型无需修改表结构
3. **版本控制**：完整记录业务数据变更历史
4. **查询性能**：关键业务查询不依赖工作流API
5. **维护性好**：业务逻辑与流程逻辑分离，便于维护

### 5.2 实施建议

1. **分阶段实施**：先实现核心流程，再完善统计分析功能
2. **数据迁移**：设计完整的数据迁移和回滚方案
3. **性能优化**：针对高频查询建立合适的索引
4. **监控告警**：建立完善的数据监控和异常告警机制

### 5.3 后续扩展点

1. **智能派单**：基于历史数据和算法优化派单策略
2. **移动端离线**：支持移动端离线操作和数据同步
3. **数据分析**：深度业务数据分析和可视化展示
4. **第三方集成**：与ERP、财务系统等第三方系统集成

---

**文档版本**: v1.0  
**创建时间**: 2024-12-25  
**维护团队**: 维保系统开发团队