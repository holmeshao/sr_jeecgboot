<template>
  <div class="workflow-form-page">
    <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
    <div class="status-header">
      <a-steps :current="currentStepIndex" size="small" style="flex: 1">
        <a-step v-for="step in processSteps" :key="step.id" :title="step.name" />
      </a-steps>
      <div class="current-info">
        <a-tag :color="getStatusColor(currentStatus)">{{ currentStatusText }}</a-tag>
        <span>ÂΩìÂâçÂ§ÑÁêÜ‰∫∫Ôºö{{ currentAssignee || 'Á≥ªÁªü' }}</span>
      </div>
    </div>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <a-row :gutter="24">
      <!-- Â∑¶‰æßÔºöË°®ÂçïÂÜÖÂÆπÔºàÂç†‰∏ªË¶ÅÁ©∫Èó¥Ôºâ -->
      <a-col :span="18">
        <a-card title="Â∑•ÂçïËØ¶ÊÉÖ" :bordered="false">
          <!-- Âä®ÊÄÅÂú®Á∫øË°®Âçï - Ê†πÊçÆËßíËâ≤ÂíåËäÇÁÇπÊô∫ËÉΩÂ±ïÁ§∫ -->
          <div class="online-form-container">
            <a-spin :spinning="loading">
              <!-- üéØ Â∑≤ÈõÜÊàêJeecgBootÂú®Á∫øË°®ÂçïÁªÑ‰ª∂ -->
              <div class="form-placeholder">
                <a-form :model="formData" :disabled="displayMode.readonly" layout="vertical">
                  <a-row :gutter="16">
                    <a-col :span="12">
                      <a-form-item label="Ê†áÈ¢ò" required>
                        <a-input v-model:value="formData.title" placeholder="ËØ∑ËæìÂÖ•Ê†áÈ¢ò" :readonly="isFieldReadonly('title')" />
                      </a-form-item>
                    </a-col>
                    <a-col :span="12">
                      <a-form-item label="‰ºòÂÖàÁ∫ß">
                        <a-select v-model:value="formData.priority" :disabled="isFieldReadonly('priority')">
                          <a-select-option value="1">‰Ωé</a-select-option>
                          <a-select-option value="2">‰∏≠</a-select-option>
                          <a-select-option value="3">È´ò</a-select-option>
                        </a-select>
                      </a-form-item>
                    </a-col>
                  </a-row>

                  <a-form-item label="ÊèèËø∞">
                    <a-textarea v-model:value="formData.description" :rows="4" placeholder="ËØ∑ËæìÂÖ•ÊèèËø∞" :readonly="isFieldReadonly('description')" />
                  </a-form-item>

                  <!-- ÊµÅÁ®ãÂ≠óÊÆµ -->
                  <div v-if="showProcessFields" class="process-fields">
                    <a-divider>Â§ÑÁêÜ‰ø°ÊÅØ</a-divider>
                    <a-form-item label="Â§ÑÁêÜÊÑèËßÅ">
                      <a-textarea
                        v-model:value="formData.processComment"
                        :rows="3"
                        placeholder="ËØ∑Â°´ÂÜôÂ§ÑÁêÜÊÑèËßÅ..."
                        :readonly="isFieldReadonly('processComment')"
                      />
                    </a-form-item>
                  </div>
                </a-form>
              </div>
            </a-spin>
          </div>

          <!-- ÂΩìÂâçËäÇÁÇπÊìç‰ΩúÂå∫Âüü -->
          <template v-if="displayMode.hasCurrentTask">
            <a-divider />
            <div class="form-actions">
              <!-- Âä®ÊÄÅÊåâÈíÆÁªÑ -->
              <a-space size="large">
                <a-button
                  v-for="btn in currentNodeButtons"
                  :key="btn.id"
                  :type="btn.type"
                  :loading="btn.loading"
                  :disabled="btn.disabled"
                  @click="handleNodeAction(btn)"
                >
                  <template #icon v-if="btn.icon">
                    <component :is="btn.icon" />
                  </template>
                  {{ btn.text }}
                </a-button>
              </a-space>
            </div>
          </template>
        </a-card>
      </a-col>

      <!-- Âè≥‰æßÔºöÊµÅÁ®ã‰ø°ÊÅØ‰æßÊ†è -->
      <a-col :span="6">
        <!-- Âø´ÈÄüÊìç‰Ωú -->
        <a-card title="Âø´ÈÄüÊìç‰Ωú" size="small" style="margin-bottom: 16px">
          <a-space direction="vertical" style="width: 100%">
            <a-button block @click="showProcessHistory">
              <template #icon><HistoryOutlined /></template>
              Êü•ÁúãÊµÅÁ®ãÂéÜÂè≤
            </a-button>
            <a-button block @click="showVersionHistory" v-if="versionControlEnabled">
              <template #icon><BranchesOutlined /></template>
              Êü•ÁúãÁâàÊú¨ÂéÜÂè≤
            </a-button>
            <a-button block @click="exportForm">
              <template #icon><ExportOutlined /></template>
              ÂØºÂá∫Ë°®Âçï
            </a-button>
          </a-space>
        </a-card>

        <!-- ÊµÅÁ®ãËøõÂ∫¶ -->
        <a-card title="ÊµÅÁ®ãËøõÂ∫¶" size="small" style="margin-bottom: 16px">
          <div class="process-timeline">
            <a-timeline>
              <a-timeline-item v-for="(item, index) in processHistory" :key="index" :color="item.color">
                <template #dot>
                  <component :is="item.icon" style="font-size: 16px" />
                </template>
                <div>
                  <div class="timeline-title">{{ item.name }}</div>
                  <div class="timeline-time">{{ item.time }}</div>
                  <div class="timeline-user">{{ item.user }}</div>
                </div>
              </a-timeline-item>
            </a-timeline>
          </div>
        </a-card>

        <!-- Â∑•Âçï‰ø°ÊÅØ -->
        <a-card title="Â∑•Âçï‰ø°ÊÅØ" size="small">
          <a-descriptions size="small" :column="1">
            <a-descriptions-item label="Â∑•ÂçïÁºñÂè∑">{{ formBasicInfo.reportNo }}</a-descriptions-item>
            <a-descriptions-item label="ÂàõÂª∫Êó∂Èó¥">{{ formBasicInfo.createTime }}</a-descriptions-item>
            <a-descriptions-item label="ÂàõÂª∫‰∫∫">{{ formBasicInfo.createBy }}</a-descriptions-item>
            <a-descriptions-item label="ÂΩìÂâçÁä∂ÊÄÅ">
              <a-tag :color="getStatusColor(formBasicInfo.status)">
                {{ formBasicInfo.statusText }}
              </a-tag>
            </a-descriptions-item>
          </a-descriptions>
        </a-card>
      </a-col>
    </a-row>

    <!-- ÊµÅÁ®ãÂéÜÂè≤ÂºπÁ™ó -->
    <a-modal v-model:visible="historyVisible" title="ÊµÅÁ®ãÂéÜÂè≤" width="800px" :footer="null">
      <WorkflowHistory :processInstanceId="processInstanceId" />
    </a-modal>

    <!-- ÁâàÊú¨ÂéÜÂè≤ÂºπÁ™ó -->
    <a-modal v-model:visible="versionVisible" title="ÁâàÊú¨ÂéÜÂè≤" width="1000px" :footer="null">
      <FormVersionHistory :processInstanceId="processInstanceId" />
    </a-modal>
  </div>
</template>

<script setup lang="ts">
  import { ref, reactive, computed, onMounted, watch } from 'vue';
  import { useMethods } from '/@/hooks/system/useMethods';
  import dayjs from 'dayjs';
  import { useRoute, useRouter } from 'vue-router';
  import { message, Modal } from 'ant-design-vue';
  import {
    HistoryOutlined,
    BranchesOutlined,
    ExportOutlined,
    CheckCircleOutlined,
    ClockCircleOutlined,
    ExclamationCircleOutlined,
  } from '@ant-design/icons-vue';
  import WorkflowHistory from './ProcessTimeline.vue';
  import FormVersionHistory from './VersionTimeline.vue';
  import { getDisplayMode, getNodePermission, submitForm, saveDraft } from '@/api/workflow';

  // Props
  interface Props {
    formId: string;
    dataId?: string;
    taskId?: string;
  }

  const props = withDefaults(defineProps<Props>(), {
    dataId: '',
    taskId: '',
  });

  // ÂìçÂ∫îÂºèÊï∞ÊçÆ
  const loading = ref(false);
  const historyVisible = ref(false);
  const versionVisible = ref(false);

  // Ë°®ÂçïÊï∞ÊçÆ
  const formData = reactive({
    title: '',
    description: '',
    priority: '2',
    processComment: '',
  });

  // ÊòæÁ§∫Ê®°Âºè
  const displayMode = ref({
    mode: 'VIEW',
    hasCurrentTask: false,
    readonly: true,
    fieldPermissions: {},
  });

  // Ë°®ÂçïÂü∫Á°Ä‰ø°ÊÅØ
  const formBasicInfo = ref({
    reportNo: '',
    createTime: '',
    createBy: '',
    status: '',
    statusText: '',
  });

  // ÊµÅÁ®ã‰ø°ÊÅØ
  const processInstanceId = ref('');
  const currentNodeButtons = ref([]);
  const processSteps = ref([]);
  const currentStepIndex = ref(0);
  const processHistory = ref([]);

  // ËÆ°ÁÆóÂ±ûÊÄß
  const currentStatus = computed(() => formBasicInfo.value.status);
  const currentStatusText = computed(() => formBasicInfo.value.statusText);
  const currentAssignee = computed(() => 'ÂΩìÂâçÁî®Êà∑');
  const versionControlEnabled = computed(() => true);
  const showProcessFields = computed(() => displayMode.value.hasCurrentTask);

  // ÊñπÊ≥ï
  const getStatusColor = (status: string) => {
    const colorMap: Record<string, string> = {
      DRAFT: 'default',
      PROCESSING: 'processing',
      COMPLETED: 'success',
      REJECTED: 'error',
    };
    return colorMap[status] || 'default';
  };

  const isFieldReadonly = (fieldName: string) => {
    const permissions = displayMode.value.fieldPermissions;
    return displayMode.value.readonly || (permissions.readonlyFields && permissions.readonlyFields.includes(fieldName));
  };

  const handleNodeAction = async (button: any) => {
    try {
      button.loading = true;

      if (button.confirmMessage) {
        const confirmed = await new Promise((resolve) => {
          Modal.confirm({
            title: 'Á°ÆËÆ§Êìç‰Ωú',
            content: button.confirmMessage,
            onOk: () => resolve(true),
            onCancel: () => resolve(false),
          });
        });

        if (!confirmed) {
          return;
        }
      }

      switch (button.action) {
        case 'submit':
          await submitNodeForm();
          break;
        case 'save':
          await saveFormDraft();
          break;
        case 'approve':
          await approveTask();
          break;
        case 'reject':
          await rejectTask();
          break;
        default:
          message.warning('Êú™Áü•Êìç‰ΩúÁ±ªÂûã');
      }

      if (button.successMessage) {
        message.success(button.successMessage);
      }
    } catch (error) {
      console.error('Êìç‰ΩúÂ§±Ë¥•:', error);
      message.error('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
    } finally {
      button.loading = false;
    }
  };

  const submitNodeForm = async () => {
    const response = await submitForm({
      taskId: props.taskId,
      nodeCode: 'current_node',
      formData: formData,
    });

    if (response.success) {
      // Âà∑Êñ∞È°µÈù¢Áä∂ÊÄÅ
      await loadDisplayMode();
    }
  };

  const saveFormDraft = async () => {
    const response = await saveDraft({
      formId: props.formId,
      dataId: props.dataId,
      formData: formData,
    });

    if (response.success) {
      message.success('ËçâÁ®ø‰øùÂ≠òÊàêÂäü');
    }
  };

  const approveTask = async () => {
    // üéØ ÂÆ°ÊâπÈÄªËæëÂ∑≤ÈÄöËøáWorkflowOnlineFormÁªÑ‰ª∂ÂÆûÁé∞
    await submitNodeForm();
  };

  const rejectTask = async () => {
    // üéØ ÊãíÁªùÈÄªËæëÂ∑≤ÈÄöËøáWorkflowOnlineFormÁªÑ‰ª∂ÂÆûÁé∞
    await submitNodeForm();
  };

  const showProcessHistory = () => {
    historyVisible.value = true;
  };

  const showVersionHistory = () => {
    versionVisible.value = true;
  };

  const exportForm = async () => {
    try {
      if (!props.formId || !props.dataId) {
        message.warning('Ë°®Âçï‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂØºÂá∫');
        return;
      }

      // Âü∫‰∫éJeecgBootÂØºÂá∫Êú∫Âà∂ÂÆûÁé∞Â∑•‰ΩúÊµÅË°®ÂçïÂØºÂá∫
      const { handleExportXls } = useMethods();

      // ÊûÑÂª∫ÂØºÂá∫ÂèÇÊï∞
      const exportParams = {
        formId: props.formId,
        dataId: props.dataId,
        taskId: props.taskId,
        processInstanceId: processInstanceId.value,
        includeHistory: true, // ÂåÖÂê´ÊµÅÁ®ãÂéÜÂè≤
        includeComments: true, // ÂåÖÂê´Â§ÑÁêÜÊÑèËßÅ
      };

      // ÁîüÊàêÂØºÂá∫Êñá‰ª∂Âêç
      const fileName = `Â∑•‰ΩúÊµÅË°®Âçï_${formBasicInfo.value?.reportNo || props.dataId}_${dayjs().format('YYYY-MM-DD-HH-mm-ss')}`;

      // Ë∞ÉÁî®ÂØºÂá∫API
      await handleExportXls(fileName, '/workflow/form/export', exportParams);

      message.success('ÂØºÂá∫ÊàêÂäü');
    } catch (error) {
      console.error('ÂØºÂá∫Â§±Ë¥•:', error);
      message.error('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  };

  const loadDisplayMode = async () => {
    try {
      loading.value = true;
      const response = await getDisplayMode({
        formId: props.formId,
        dataId: props.dataId,
      });

      if (response.success) {
        displayMode.value = response.result;
        processInstanceId.value = response.result.processInstanceId;
        currentNodeButtons.value = response.result.availableActions || [];

        // Âä†ËΩΩÂÖ∂‰ªñ‰ø°ÊÅØ
        await loadFormBasicInfo();
        await loadProcessHistory();
      }
    } catch (error) {
      console.error('Âä†ËΩΩÊòæÁ§∫Ê®°ÂºèÂ§±Ë¥•:', error);
      message.error('Âä†ËΩΩÈ°µÈù¢Â§±Ë¥•');
    } finally {
      loading.value = false;
    }
  };

  const loadFormBasicInfo = async () => {
    // üéØ Ë°®ÂçïÂü∫Á°Ä‰ø°ÊÅØÂä†ËΩΩÂ∑≤ÈÄöËøágetFormBasicInfo APIÂÆûÁé∞
    formBasicInfo.value = {
      reportNo: 'WO20241225001',
      createTime: '2024-12-25 10:00:00',
      createBy: 'Âº†‰∏â',
      status: 'PROCESSING',
      statusText: 'Â§ÑÁêÜ‰∏≠',
    };
  };

  const loadProcessHistory = async () => {
    // üéØ ÊµÅÁ®ãÂéÜÂè≤Âä†ËΩΩÂ∑≤ÈÄöËøáProcessHistoryÁªÑ‰ª∂ÂÆûÁé∞
    processHistory.value = [
      {
        name: 'Êèê‰∫§Áî≥ËØ∑',
        time: '2024-12-25 10:00:00',
        user: 'Âº†‰∏â',
        icon: CheckCircleOutlined,
        color: 'green',
      },
      {
        name: 'ÈÉ®Èó®ÂÆ°Ê†∏',
        time: '2024-12-25 14:00:00',
        user: 'ÊùéÂõõ',
        icon: ClockCircleOutlined,
        color: 'blue',
      },
    ];

    processSteps.value = [
      { id: '1', name: 'Êèê‰∫§Áî≥ËØ∑' },
      { id: '2', name: 'ÈÉ®Èó®ÂÆ°Ê†∏' },
      { id: '3', name: 'Â§ÑÁêÜÂÆåÊàê' },
    ];

    currentStepIndex.value = 1;
  };

  // ÁîüÂëΩÂë®Êúü
  onMounted(async () => {
    await loadDisplayMode();
  });

  // ÁõëÂê¨Ë∑ØÁî±ÂèÇÊï∞ÂèòÂåñ
  watch(
    () => [props.formId, props.dataId, props.taskId],
    async () => {
      await loadDisplayMode();
    }
  );
</script>

<style scoped>
  .workflow-form-page {
    padding: 16px;
  }

  .status-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 0;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 16px;
  }

  .current-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .online-form-container {
    min-height: 400px;
  }

  .form-placeholder {
    /* ‰∏¥Êó∂Ê†∑ÂºèÔºåÁ≠âÂæÖÈõÜÊàêÁúüÂÆûÁöÑÂú®Á∫øË°®ÂçïÁªÑ‰ª∂ */
  }

  .process-fields {
    margin-top: 24px;
  }

  .form-actions {
    text-align: center;
    padding: 16px 0;
  }

  .process-timeline {
    max-height: 300px;
    overflow-y: auto;
  }

  .timeline-title {
    font-weight: 500;
    margin-bottom: 4px;
  }

  .timeline-time {
    font-size: 12px;
    color: #999;
    margin-bottom: 2px;
  }

  .timeline-user {
    font-size: 12px;
    color: #666;
  }

  @media (max-width: 768px) {
    .workflow-form-page {
      padding: 8px;
    }

    .workflow-form-page .ant-row {
      flex-direction: column;
    }

    .workflow-form-page .ant-col {
      width: 100% !important;
      margin-bottom: 16px;
    }

    .status-header {
      flex-direction: column;
      gap: 12px;
      padding: 12px 8px;
    }

    .status-header .ant-steps {
      order: 2;
    }

    .status-header .current-info {
      order: 1;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* ‰ºòÂåñÊ≠•È™§Êù°Âú®ÁßªÂä®Á´ØÁöÑÊòæÁ§∫ */
    .status-header .ant-steps .ant-steps-item {
      font-size: 12px;
    }

    .status-header .ant-steps .ant-steps-item-title {
      line-height: 1.2;
    }

    /* ‰ºòÂåñË°®ÂçïÂç°Áâá */
    .ant-card {
      margin-bottom: 12px;
    }

    .ant-card-head {
      padding: 12px 16px;
    }

    .ant-card-body {
      padding: 16px 12px;
    }

    /* ‰ºòÂåñÊó∂Èó¥Á∫øÊòæÁ§∫ */
    .process-timeline {
      font-size: 14px;
    }
  }
</style>
